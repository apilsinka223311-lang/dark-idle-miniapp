<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Dark Idle</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background: #0e0e11;
  color: #ffffff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
  margin: 0;
  padding-bottom: 100px;
}

h1 {
  font-size: 26px;
  margin-bottom: 16px;
}

/* ===== VOID CARD ===== */
.void-card {
  background: radial-gradient(circle at top, #1a1a25, #0b0b0f);
  border-radius: 24px;
  padding: 30px 20px;
  box-shadow:
    0 0 40px rgba(111, 66, 193, 0.25),
    inset 0 0 30px rgba(0,0,0,0.8);
  margin-top: 20px;
}

/* ===== VOID RING ===== */
.void-ring {
  position: relative;
  width: 180px;
  height: 180px;
  margin: 0 auto 20px;
  cursor: pointer;
}

.void-ring svg {
  width: 100%;
  height: 100%;
}

.ring {
  transform-origin: 50% 50%;
  animation: rotate 22s linear infinite;
  transition: filter 0.3s, animation-duration 0.3s;
}

.void-ring.active .ring {
  animation-duration: 6s;
  filter: brightness(1.4);
}

/* ===== PARTICLES ===== */
.particle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 4px;
  height: 4px;
  background: #9f8cff;
  border-radius: 50%;
  opacity: 0.7;
  animation: orbit 14s linear infinite;
}

.p1 { animation-duration: 10s; }
.p2 { animation-duration: 14s; }
.p3 { animation-duration: 18s; }
.p4 { animation-duration: 22s; }

@keyframes orbit {
  from { transform: rotate(0deg) translateX(80px) rotate(0deg); }
  to   { transform: rotate(360deg) translateX(80px) rotate(-360deg); }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

/* ===== TEXT ===== */
.void-amount {
  font-size: 32px;
  font-weight: bold;
  margin-bottom: 6px;
}

.void-sub {
  font-size: 14px;
  opacity: 0.7;
  margin-bottom: 20px;
}

.void-btn {
  background: linear-gradient(135deg, #6f42c1, #8a63ff);
  box-shadow: 0 0 20px rgba(138,99,255,0.6);
  border: none;
  padding: 16px;
  color: white;
  font-size: 16px;
  border-radius: 14px;
  cursor: pointer;
  width: 100%;
  max-width: 320px;
  margin: 10px auto;
}

.void-info {
  margin-top: 15px;
  font-size: 15px;
  opacity: 0.85;
}

/* ===== RATING ===== */
#leaderboard div {
  padding: 10px;
  border-bottom: 1px solid #2a2a33;
  text-align: left;
}

/* ===== TABBAR ===== */
#tabbar {
  position: fixed;
  bottom: 12px;
  left: 12px;
  right: 12px;
  height: 64px;
  background: rgba(20,20,30,0.6);
  backdrop-filter: blur(14px);
  border-radius: 20px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  z-index: 10;
}

.tab {
  flex: 1;
  text-align: center;
  color: #888;
  font-size: 12px;
  transition: all 0.25s ease;
  position: relative;
  cursor: pointer;
}

.tab-icon {
  font-size: 20px;
}

.tab-label {
  margin-top: 4px;
}

.tab.active {
  color: #cbb6ff;
}

.tab.active::before {
  content: "";
  position: absolute;
  inset: -6px;
  background: rgba(140,100,255,0.15);
  border-radius: 16px;
  filter: blur(8px);
  z-index: -1;
}

  #voidCanvas {
  width: 180px;
  height: 180px;
  margin: 0 auto 20px;
  display: block;
  border-radius: 50%;
}
  
</style>
</head>

<body>

<h1>Dark Idle</h1>

<!-- GAME -->
<div id="game">
  <div class="void-card">

   <canvas id="voidCanvas" width="400" height="400"></canvas>

    <div class="void-amount" id="counter">VOID: 0</div>
    <div class="void-sub">–¢—ë–º–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –∏—Å–∫–∞–∂–∞–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</div>

    <button class="void-btn" onclick="collect()">–ò–∑–≤–ª–µ—á—å VOID</button>
    <div class="void-info" id="info"></div>
    <button class="void-btn" onclick="upgrade()">–£–ª—É—á—à–∏—Ç—å –¥–æ–±—ã—á—É (+1 VOID/—Å–µ–∫)</button>
  </div>
</div>

<!-- RATING -->
<div id="rating" style="display:none">
  <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
  <div id="leaderboard"></div>
</div>

<!-- TABBAR -->
<div id="tabbar">
  <div class="tab active" onclick="showTab('game', this)">
    <div class="tab-icon">‚óâ</div>
    <div class="tab-label">–ò–≥—Ä–∞</div>
  </div>
  <div class="tab" onclick="showTab('rating', this)">
    <div class="tab-icon">üèÜ</div>
    <div class="tab-label">–†–µ–π—Ç–∏–Ω–≥</div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://edosyzmykmoajecmaamu.supabase.co";
const SUPABASE_KEY = "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const tg = Telegram.WebApp;
const user = tg.initDataUnsafe?.user;
tg.ready();

let data = { voids: 0, rate: 1, is_vip: false, lastTime: Date.now() };

/* ================= GAME LOGIC ================= */

function updateIdle() {
  const now = Date.now();
  const seconds = Math.floor((now - data.lastTime) / 1000);
  if (seconds > 0) {
    data.voids += seconds * data.rate * (data.is_vip ? 2 : 1);
    data.lastTime = now;
  }
}

function render() {
  const cost = 20 * data.rate * data.rate;

  document.getElementById("counter").innerText =
    `VOID: ${Math.floor(data.voids)}`;

  document.getElementById("info").innerText =
    `–°–∫–æ—Ä–æ—Å—Ç—å: ${data.rate} VOID/—Å–µ–∫ ${data.is_vip ? "üëë VIP" : ""}\n` +
    `–¶–µ–Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è: ${cost} VOID`;
}

function collect() {
  Telegram.WebApp.HapticFeedback.impactOccurred("light");

  pulse = 1; // —Ä–µ–∞–∫—Ü–∏—è Canvas

  updateIdle();
  render();
  savePlayer();
}

function upgrade() {
  const cost = 20 * data.rate * data.rate;

  if (data.voids < cost) {
    Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ VOID");
    return;
  }

  data.voids -= cost;
  data.rate += 1;

  render();
  savePlayer();
}

/* ================= SERVER ================= */

async function loadPlayer() {
  const { data: p } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", user.id)
    .single();

  if (!p) {
    await supabase.from("players").insert({
      telegram_id: user.id,
      voids: 0,
      rate: 1,
      is_vip: false
    });
    return { voids: 0, rate: 1, is_vip: false };
  }
  return p;
}

async function savePlayer() {
  await supabase.from("players").update({
    voids: Math.floor(data.voids),
    rate: data.rate,
    is_vip: data.is_vip,
    updated_at: new Date()
  }).eq("telegram_id", user.id);
}

async function loadLeaderboard() {
  const { data: list } = await supabase
    .from("players")
    .select("telegram_id, voids, is_vip")
    .order("voids", { ascending: false })
    .limit(100);

  const board = document.getElementById("leaderboard");
  board.innerHTML = "";

  list.forEach((p, i) => {
    const row = document.createElement("div");
    row.innerText =
      `${i + 1}. ${p.telegram_id === user.id ? "üî• –¢—ã" : "–ò–≥—Ä–æ–∫"} ${p.is_vip ? "üëë" : ""} ‚Äî ${p.voids} VOID`;
    board.appendChild(row);
  });
}

function showTab(tab, el) {
  document.getElementById("game").style.display = tab === "game" ? "block" : "none";
  document.getElementById("rating").style.display = tab === "rating" ? "block" : "none";
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  el.classList.add("active");
  if (tab === "rating") loadLeaderboard();
}

/* ================= INIT ================= */

(async () => {
  const p = await loadPlayer();
  data.voids = p.voids;
  data.rate = p.rate;
  data.is_vip = p.is_vip;
  data.lastTime = Date.now();

  render();
  loadLeaderboard();

  setInterval(savePlayer, 15000);
  setInterval(loadLeaderboard, 20000);
})();

/* ================= CANVAS VOID ================= */

const canvas = document.getElementById("voidCanvas");
const ctx = canvas.getContext("2d");

const DPR = window.devicePixelRatio || 1;
const SIZE = 180;

canvas.width = SIZE * DPR;
canvas.height = SIZE * DPR;
canvas.style.width = SIZE + "px";
canvas.style.height = SIZE + "px";

ctx.scale(DPR, DPR);

let time = 0;
let pulse = 0;

canvas.addEventListener("click", () => {
  pulse = 1;
  collect();
});

function drawVoid() {
  const w = SIZE;
  const h = SIZE;
  const cx = w / 2;
  const cy = h / 2;
  const baseRadius = 58;

  ctx.clearRect(0, 0, w, h);

  // –ü–£–°–¢–û–¢–ê
  ctx.beginPath();
  ctx.arc(cx, cy, baseRadius, 0, Math.PI * 2);
  ctx.fillStyle = "#000";
  ctx.fill();

  // –≠–ù–ï–†–ì–ï–¢–ò–ß–ï–°–ö–û–ï –ö–û–õ–¨–¶–û
  const dots = 140;
  for (let i = 0; i < dots; i++) {
    const angle = (i / dots) * Math.PI * 2;
    const noise =
      Math.sin(time * 0.02 + angle * 4) * (5 + data.rate * 0.6);

    const r = baseRadius + 14 + noise;
    const x = cx + Math.cos(angle) * r;
    const y = cy + Math.sin(angle) * r;

    ctx.fillStyle = "rgba(160,130,255,0.28)";
    ctx.beginPath();
    ctx.arc(x, y, 2.2, 0, Math.PI * 2);
    ctx.fill();
  }

  // –í–°–ü–õ–ï–°–ö
  if (pulse > 0.01) {
    ctx.strokeStyle = `rgba(200,170,255,${pulse})`;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(cx, cy, baseRadius + 18 * pulse, 0, Math.PI * 2);
    ctx.stroke();
    pulse *= 0.9;
  }

  time++;
  requestAnimationFrame(drawVoid);
}

drawVoid();
</script>


</body>
</html>
