<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASH: Dark Cosmos</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&family=Orbitron:wght@500;800&display=swap" rel="stylesheet">

    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-deep: #050508;
            --bg-card: rgba(20, 20, 25, 0.6);
            --primary: #8a63ff; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –Ω–µ–æ–Ω */
            --primary-glow: rgba(138, 99, 255, 0.6);
            --secondary: #d946ef; /* –†–æ–∑–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç */
            --text-main: #ffffff;
            --text-muted: #8888aa;
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Exo 2', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        body {
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 30%, #1a1033 0%, #050508 80%);
            color: var(--text-main);
            font-family: var(--font-body);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- LAYOUT --- */
        .screen {
            flex: 1;
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-bottom: 100px; /* –ú–µ—Å—Ç–æ –¥–ª—è —Ç–∞–±–±–∞—Ä–∞ */
            overflow-y: auto;
            animation: fadein 0.3s ease;
        }
        .screen.active { display: flex; }

        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 {
            font-family: var(--font-head);
            font-size: 28px;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 15px var(--primary-glow);
            margin-top: 10px;
        }

        /* --- THE CORE (NO IMAGES, CSS ONLY) --- */
        .core-wrapper {
            position: relative;
            width: 280px; height: 280px;
            margin: 20px 0;
            display: flex; justify-content: center; align-items: center;
        }

        /* –°–∞–º–æ —è–¥—Ä–æ */
        .core-sphere {
            width: 180px; height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #d4bfff, #8a63ff, #240046);
            box-shadow: 
                0 0 60px var(--primary-glow),
                inset -20px -20px 40px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
            animation: float 6s ease-in-out infinite;
        }

        /* –ö–æ–ª—å—Ü–∞ –≤–æ–∫—Ä—É–≥ —è–¥—Ä–∞ */
        .orbit {
            position: absolute;
            border: 1px solid rgba(138, 99, 255, 0.3);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(138, 99, 255, 0.1);
        }
        .orbit-1 { width: 240px; height: 240px; animation: spin 10s linear infinite; border-top-color: var(--secondary); }
        .orbit-2 { width: 280px; height: 280px; animation: spin-rev 15s linear infinite; border-bottom-color: var(--primary); }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes spin-rev { 100% { transform: translate(-50%, -50%) rotate(-360deg); } }

        /* --- STATS --- */
        .balance-container { text-align: center; margin-bottom: 25px; }
        .ash-count {
            font-family: var(--font-head);
            font-size: 42px; font-weight: 800;
            background: linear-gradient(180deg, #fff, #a086ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .ash-label { font-size: 12px; letter-spacing: 4px; color: var(--text-muted); text-transform: uppercase; }

        /* --- BUTTONS --- */
        .actions { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 12px; }

        .btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 18px;
            border-radius: 18px;
            font-size: 16px; font-weight: 700;
            font-family: var(--font-body);
            text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer;
            position: relative; overflow: hidden;
            transition: 0.2s;
            backdrop-filter: blur(10px);
        }

        .btn-main {
            background: linear-gradient(135deg, var(--primary), #6333ff);
            box-shadow: 0 8px 25px rgba(138, 99, 255, 0.4);
            border: none;
        }

        .btn:active { transform: scale(0.96); }
        .btn-main:active { box-shadow: 0 4px 15px rgba(138, 99, 255, 0.3); }

        .upgrade-info {
            display: flex; justify-content: space-between;
            font-size: 12px; opacity: 0.8; margin-top: 5px;
        }

        /* --- RATING --- */
        .rating-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 15px;
            width: 100%; max-width: 400px;
            margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .rating-card.me { border-color: var(--primary); background: rgba(138, 99, 255, 0.15); }
        .rank-num { font-family: var(--font-head); color: var(--text-muted); width: 30px; }
        .rank-name { flex: 1; font-weight: 600; }
        .rank-val { font-family: var(--font-head); color: var(--secondary); }

        /* --- TABBAR --- */
        .tabbar {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            height: 70px;
            background: rgba(15, 15, 20, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .tab {
            display: flex; flex-direction: column; align-items: center;
            opacity: 0.4; transition: 0.3s; cursor: pointer;
            width: 60px;
        }
        .tab.active { opacity: 1; }
        
        .tab-icon { font-size: 22px; margin-bottom: 4px; filter: drop-shadow(0 0 5px var(--primary)); }
        .tab-text { font-size: 10px; font-weight: 600; text-transform: uppercase; }

        /* --- Floating Numbers Animation --- */
        .floater {
            position: absolute;
            color: #fff; font-weight: bold; font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s forwards;
            font-family: var(--font-head);
            text-shadow: 0 0 10px var(--primary);
        }
        @keyframes floatUp { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="screen-game" class="screen active">
        <h1>ASH PROJECT</h1>
        
        <div class="core-wrapper" id="clickArea">
            <div class="orbit orbit-1"></div>
            <div class="orbit orbit-2"></div>
            <div class="core-sphere"></div>
        </div>

        <div class="balance-container">
            <div class="ash-count" id="ui-balance">0</div>
            <div class="ash-label">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –º–∞—Ç–µ—Ä–∏—è</div>
        </div>

        <div class="actions">
            <button class="btn btn-main" onclick="collect()">–ò–ó–í–õ–ï–ß–¨</button>
            
            <button class="btn" onclick="upgrade()">
                –£–õ–£–ß–®–ò–¢–¨ –Ø–î–†–û
                <div class="upgrade-info">
                    <span id="ui-rate">Rate: 1/sec</span>
                    <span id="ui-cost" style="color: var(--secondary)">Cost: 20</span>
                </div>
            </button>
        </div>
    </div>

    <div id="screen-rating" class="screen">
        <h1>TOP MINERS</h1>
        <div id="leaderboard" style="width: 100%; margin-top: 10px;">
            <div style="text-align:center; opacity:0.5; margin-top:50px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <div class="tabbar">
        <div class="tab active" id="tab-game" onclick="setTab('game')">
            <div class="tab-icon">üåÄ</div>
            <div class="tab-text">Core</div>
        </div>
        <div class="tab" id="tab-rating" onclick="setTab('rating')">
            <div class="tab-icon">üèÜ</div>
            <div class="tab-text">Rating</div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const supabase = window.supabase.createClient(
            "https://edosyzmykmoajecmaamu.supabase.co",
            "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O"
        );

        const tg = Telegram.WebApp;
        tg.expand();
        // –í–∫–ª—é—á–∞–µ–º —Ç–µ–º–Ω—É—é —Ç–µ–º—É —Ö–µ–¥–µ—Ä–∞ —Ç–µ–ª–µ–≥—Ä–∞–º
        tg.setHeaderColor('#050508');
        tg.setBackgroundColor('#050508');

        // --- 2. STATE ---
        let state = {
            ash: 0,         // –ë–∞–ª–∞–Ω—Å (voids –≤ –ë–î)
            rate: 1,        // –î–æ–±—ã—á–∞ –≤ —Å–µ–∫
            last_seen: Date.now(),
            user_id: null,
            username: "Unknown",
            is_vip: false
        };

        // --- 3. INIT LOGIC ---
        async function init() {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –±–µ—Ä–µ–º —Ñ–µ–π–∫–æ–≤—ã–π ID
            const tgUser = tg.initDataUnsafe?.user;
            
            if (tgUser) {
                state.user_id = tgUser.id;
                state.username = tgUser.username || tgUser.first_name;
            } else {
                // FALLBACK –î–õ–Ø –ë–†–ê–£–ó–ï–†–ê (—á—Ç–æ–±—ã —Ç—ã –º–æ–≥ —Ç–µ—Å—Ç–∏—Ç—å –±–µ–∑ –¢–µ–ª–µ–≥—Ä–∞–º)
                console.log("No TG user found, using dev ID");
                state.user_id = 12345; // –¢–µ—Å—Ç–æ–≤—ã–π ID
                state.username = "Dev_User";
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –±–∞–∑—ã
            let { data: p, error } = await supabase
                .from("players")
                .select("*")
                .eq("telegram_id", state.user_id)
                .single();

            if (!p && !error) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ, –µ—Å–ª–∏ –Ω–µ—Ç
                const newPlayer = {
                    telegram_id: state.user_id,
                    username: state.username,
                    voids: 0,
                    rate: 1,
                    last_seen: new Date().toISOString()
                };
                await supabase.from("players").insert(newPlayer);
                p = newPlayer;
            } else if (p) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
                state.ash = p.voids; // –í–ê–ñ–ù–û: –º–∞–ø–ø–∏–Ω–≥ voids -> ash
                state.rate = p.rate;
                // –ï—Å–ª–∏ last_seen –µ—Å—Ç—å, —Å—á–∏—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥
                const last = new Date(p.last_seen).getTime();
                const now = Date.now();
                const diffSec = Math.floor((now - last) / 1000);
                if (diffSec > 0) {
                    const earned = diffSec * state.rate * (p.is_vip ? 2 : 1);
                    console.log(`Offline earned: ${earned}`);
                    state.ash += earned;
                }
            }

            state.last_seen = Date.now();
            updateUI();
            requestAnimationFrame(gameLoop);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑ –≤ 5 —Å–µ–∫
            setInterval(save, 5000);
        }

        // --- 4. GAME LOOP & VISUALS ---
        function gameLoop() {
            const now = Date.now();
            const dt = (now - state.last_seen) / 1000;
            
            if (dt >= 1) {
                state.ash += state.rate * dt; // –î–æ–±–∞–≤–ª—è–µ–º ASH
                state.last_seen = now;
                updateUI();
            } else {
                // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –≥–ª–∞–∑ (—Ç–æ–ª—å–∫–æ UI)
                const predicted = state.ash + (state.rate * dt);
                document.getElementById('ui-balance').innerText = Math.floor(predicted).toLocaleString();
            }
            
            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            document.getElementById('ui-balance').innerText = Math.floor(state.ash).toLocaleString();
            document.getElementById('ui-rate').innerText = `Rate: ${state.rate}/s`;
            
            const cost = 20 * state.rate * state.rate;
            document.getElementById('ui-cost').innerText = `Cost: ${cost.toLocaleString()}`;
        }

        // --- 5. ACTIONS ---
        function collect(e) {
            tg.HapticFeedback.impactOccurred("light");
            
            // –≠—Ñ—Ñ–µ–∫—Ç –≤—ã–ª–µ—Ç–∞—é—â–µ–π —Ü–∏—Ñ—Ä—ã
            showFloatingText("+1");

            // –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å, –ª–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏–¥–µ—Ç –≤ loop
            // –ù–æ –º–æ–∂–Ω–æ –¥–∞—Ç—å –±–æ–Ω—É—Å –∑–∞ –∫–ª–∏–∫, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å:
            // state.ash += 1; 
        }

        function upgrade() {
            const cost = 20 * state.rate * state.rate;
            if (state.ash >= cost) {
                state.ash -= cost;
                state.rate += 1;
                tg.HapticFeedback.notificationOccurred("success");
                updateUI();
                save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
            } else {
                tg.HapticFeedback.notificationOccurred("error");
            }
        }

        async function save() {
            if(!state.user_id) return;
            
            await supabase.from("players").update({
                voids: Math.floor(state.ash),
                rate: state.rate,
                last_seen: new Date().toISOString(),
                username: state.username
            }).eq("telegram_id", state.user_id);
        }

        // --- 6. VISUAL EFFECTS ---
        function showFloatingText(text) {
            const el = document.createElement('div');
            el.className = 'floater';
            el.innerText = text;
            // –ü–æ–∑–∏—Ü–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
            el.style.left = '50%';
            el.style.top = '40%';
            el.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- 7. TABS & RATING ---
        function setTab(tab) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`screen-${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');

            if(tab === 'rating') loadLeaderboard();
        }

        async function loadLeaderboard() {
            const { data, error } = await supabase
                .from("players")
                .select("*")
                .order("voids", { ascending: false })
                .limit(20);

            const list = document.getElementById('leaderboard');
            if(data) {
                list.innerHTML = data.map((p, i) => `
                    <div class="rating-card ${p.telegram_id == state.user_id ? 'me' : ''}">
                        <div class="rank-num">#${i + 1}</div>
                        <div class="rank-name">${p.username}</div>
                        <div class="rank-val">${p.voids.toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        // START
        init();

    </script>
</body>
</html>
