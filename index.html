<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Dark Idle</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      background: #0e0e11;
      color: #ffffff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    h1 { font-size: 28px; margin-bottom: 10px; }
    h2 { margin-top: 0; }

    p { font-size: 18px; }

    button {
      background: #6f42c1;
      border: none;
      padding: 16px;
      color: white;
      font-size: 16px;
      border-radius: 14px;
      cursor: pointer;
      width: 100%;
      max-width: 320px;
      margin: 8px auto;
      display: block;
    }

    #tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #14141a;
      display: flex;
      border-top: 1px solid #2a2a33;
    }

    #tabs button {
      flex: 1;
      margin: 0;
      border-radius: 0;
      background: transparent;
      color: #aaa;
    }

    #tabs button.active {
      color: #fff;
      background: #1f1f2a;
    }

    #leaderboard div {
      padding: 8px;
      border-bottom: 1px solid #2a2a33;
    }
  </style>
</head>

<body>

<h1>Dark Idle</h1>

<!-- GAME -->
<div id="game">
  <p id="counter">VOID: 0</p>
  <p id="info"></p>

  <button onclick="collect()">–ó–∞–±—Ä–∞—Ç—å VOID</button>
  <button onclick="upgrade()">–£–ª—É—á—à–∏—Ç—å –¥–æ–±—ã—á—É</button>
</div>

<!-- RATING -->
<div id="rating" style="display:none">
  <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
  <div id="leaderboard"></div>
</div>

<!-- TABS -->
<div id="tabs">
  <button id="tab-game" class="active" onclick="showTab('game')">üéÆ –ò–≥—Ä–∞</button>
  <button id="tab-rating" onclick="showTab('rating')">üèÜ –†–µ–π—Ç–∏–Ω–≥</button>
</div>

<!-- SUPABASE INIT -->
<script>
  const SUPABASE_URL = "https://edosyzmykmoajecmaamu.supabase.co";
  const SUPABASE_KEY = "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );
</script>

<!-- GAME LOGIC -->
<script>
  const tg = Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;

  if (!user) {
    alert("–û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram");
  }

  tg.ready();

  let data = {
    voids: 0,
    rate: 1,
    lastTime: Date.now()
  };

  function updateIdle() {
    const now = Date.now();
    const seconds = Math.floor((now - data.lastTime) / 1000);
    if (seconds > 0) {
      data.voids += seconds * data.rate;
      data.lastTime = now;
    }
  }

  function render() {
    document.getElementById("counter").innerText =
      `VOID: ${Math.floor(data.voids)}`;
    document.getElementById("info").innerText =
      `–°–∫–æ—Ä–æ—Å—Ç—å: ${data.rate} VOID/—Å–µ–∫`;
  }

  function collect() {
    updateIdle();
    render();
    savePlayerToServer();
  }

  function upgrade() {
    if (data.voids >= 10) {
      data.voids -= 10;
      data.rate++;
      render();
      savePlayerToServer();
    } else {
      alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ VOID");
    }
  }

  async function loadPlayerFromServer() {
    const telegramId = user.id;

    let { data: player } = await supabase
      .from("players")
      .select("*")
      .eq("telegram_id", telegramId)
      .single();

    if (!player) {
      await supabase.from("players").insert({
        telegram_id: telegramId,
        voids: 0,
        rate: 1
      });

      return { voids: 0, rate: 1 };
    }

    return player;
  }

  async function savePlayerToServer() {
    await supabase
      .from("players")
      .update({
        voids: Math.floor(data.voids),
        rate: data.rate,
        updated_at: new Date()
      })
      .eq("telegram_id", user.id);
  }

  async function loadLeaderboard() {
    const { data: list } = await supabase
      .from("players")
      .select("telegram_id, voids")
      .order("voids", { ascending: false })
      .limit(100);

    const board = document.getElementById("leaderboard");
    board.innerHTML = "";

    list.forEach((p, i) => {
      const row = document.createElement("div");
      const isMe = p.telegram_id === user.id;

      row.innerText = `${i + 1}. ${isMe ? "üî• –¢—ã" : "–ò–≥—Ä–æ–∫"} ‚Äî ${p.voids} VOID`;
      row.style.color = isMe ? "#ffd700" : "#fff";
      row.style.fontWeight = isMe ? "bold" : "normal";

      board.appendChild(row);
    });
  }

  function showTab(tab) {
    document.getElementById("game").style.display =
      tab === "game" ? "block" : "none";
    document.getElementById("rating").style.display =
      tab === "rating" ? "block" : "none";

    document.getElementById("tab-game").classList.toggle("active", tab === "game");
    document.getElementById("tab-rating").classList.toggle("active", tab === "rating");

    if (tab === "rating") {
      loadLeaderboard();
    }
  }

  (async () => {
    const serverData = await loadPlayerFromServer();

    data.voids = serverData.voids;
    data.rate = serverData.rate;
    data.lastTime = Date.now();

    render();
    loadLeaderboard();

    setInterval(savePlayerToServer, 15000);
    setInterval(loadLeaderboard, 20000);
  })();
</script>

</body>
</html>
