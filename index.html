<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Dark Idle</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background: #0e0e11;
  color: #ffffff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
  margin: 0;
  padding-bottom: 100px;
}

h1 {
  font-size: 26px;
  margin-bottom: 16px;
}

/* ===== CARD ===== */
.void-card {
  background: radial-gradient(circle at top, #1a1a25, #0b0b0f);
  border-radius: 24px;
  padding: 30px 20px;
  box-shadow:
    0 0 40px rgba(111, 66, 193, 0.25),
    inset 0 0 30px rgba(0,0,0,0.8);
  margin-top: 20px;
}

/* ===== VOID IMAGE ===== */
.void-orb {
  width: 260px;
  height: 260px;
  margin: 0 auto 20px;
  border-radius: 50%;
  overflow: hidden;
}

#voidImage {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter:
    drop-shadow(0 0 60px rgba(160,130,255,0.75))
    brightness(1.15)
    contrast(1.1);
  animation: rotateVoid 60s linear infinite;
}

@keyframes rotateVoid {
  from { transform: rotate(0deg) scale(1.05); }
  to   { transform: rotate(360deg) scale(1.05); }
}

/* ===== TEXT ===== */
.void-amount {
  font-size: 32px;
  font-weight: bold;
  margin-bottom: 6px;
}

.void-sub {
  font-size: 14px;
  opacity: 0.7;
  margin-bottom: 20px;
}

.void-btn {
  background: linear-gradient(135deg, #6f42c1, #8a63ff);
  box-shadow: 0 0 20px rgba(138,99,255,0.6);
  border: none;
  padding: 16px;
  color: white;
  font-size: 16px;
  border-radius: 14px;
  cursor: pointer;
  width: 100%;
  max-width: 320px;
  margin: 10px auto;
}

.void-info {
  margin-top: 15px;
  font-size: 15px;
  opacity: 0.85;
}

/* ===== RATING ===== */
#leaderboard div {
  padding: 10px;
  border-bottom: 1px solid #2a2a33;
  text-align: left;
}

/* ===== TABBAR ===== */
#tabbar {
  position: fixed;
  bottom: 12px;
  left: 12px;
  right: 12px;
  height: 64px;
  background: rgba(20,20,30,0.6);
  backdrop-filter: blur(14px);
  border-radius: 20px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  z-index: 10;
}

.tab {
  flex: 1;
  text-align: center;
  color: #888;
  font-size: 12px;
  cursor: pointer;
}

.tab.active {
  color: #cbb6ff;
}

  /* ===== RATING ===== */

.rating-card {
  background: linear-gradient(180deg, #141420, #0b0b12);
  border-radius: 22px;
  padding: 20px;
  box-shadow: 0 0 40px rgba(120,90,255,0.15);
}

.rating-title {
  margin-bottom: 16px;
  font-size: 22px;
}

/* TOP 3 */
.top3 {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}

.top3-item {
  flex: 1;
  padding: 12px;
  border-radius: 16px;
  text-align: center;
  font-size: 14px;
}

.top3-item.gold {
  background: linear-gradient(135deg, #ffd70033, #000);
  color: #ffd700;
}

.top3-item.silver {
  background: linear-gradient(135deg, #c0c0c033, #000);
  color: #ddd;
}

.top3-item.bronze {
  background: linear-gradient(135deg, #cd7f3233, #000);
  color: #cd7f32;
}

/* LIST */
.leaderboard {
  max-height: 420px;
  overflow-y: auto;
}

.lb-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: 12px;
  margin-bottom: 6px;
  background: rgba(255,255,255,0.04);
  font-size: 14px;
}

.lb-row.me {
  background: rgba(140,100,255,0.2);
  color: #fff;
  font-weight: bold;
}

/* MY RANK */
.my-rank {
  margin-top: 14px;
  padding: 14px;
  border-radius: 16px;
  background: rgba(140,100,255,0.18);
  font-size: 15px;
  box-shadow: 0 0 20px rgba(140,100,255,0.25);
}

</style>
</head>

<body>

<h1>Dark Idle</h1>

<!-- GAME -->
<div id="game">
  <div class="void-card">

    <div class="void-orb">
      <img src="void.png" id="voidImage">
    </div>

    <div class="void-amount" id="counter">VOID: 0</div>
    <div class="void-sub">–¢—ë–º–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –∫–æ–Ω–¥–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è</div>

    <button class="void-btn" onclick="collect()">–ò–∑–≤–ª–µ—á—å VOID</button>
    <div class="void-info" id="info"></div>
    <button class="void-btn" onclick="upgrade()">–£–ª—É—á—à–∏—Ç—å –¥–æ–±—ã—á—É</button>

  </div>
</div>

<!-- RATING -->
<div id="rating" style="display:none">

  <div class="rating-card">

    <h2 class="rating-title">üèÜ –†–µ–π—Ç–∏–Ω–≥ VOID</h2>

    <!-- TOP 3 -->
    <div id="top3" class="top3"></div>

    <!-- LIST -->
    <div id="leaderboard" class="leaderboard"></div>

  </div>

  <!-- YOUR POSITION -->
  <div id="my-rank" class="my-rank"></div>

</div>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://edosyzmykmoajecmaamu.supabase.co";
const SUPABASE_KEY = "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== TELEGRAM ===== */
const tg = Telegram.WebApp;
const user = tg.initDataUnsafe?.user;
tg.ready();

if (!user) {
  alert("–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram");
}

/* ===== DATA ===== */
let data = {
  voids: 0,
  rate: 1,
  is_vip: false,
  lastTime: Date.now()
};

/* ===== GAME LOGIC ===== */
function updateIdle() {
  const now = Date.now();
  const seconds = Math.floor((now - data.lastTime) / 1000);
  if (seconds > 0) {
    data.voids += seconds * data.rate * (data.is_vip ? 2 : 1);
    data.lastTime = now;
  }
}

function render() {
  const cost = 20 * data.rate * data.rate;
  counter.innerText = `VOID: ${Math.floor(data.voids)}`;
  info.innerText =
    `–°–∫–æ—Ä–æ—Å—Ç—å: ${data.rate} VOID/—Å–µ–∫ ${data.is_vip ? "üëë VIP" : ""}\n` +
    `–¶–µ–Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è: ${cost} VOID`;
}

function collect() {
  Telegram.WebApp.HapticFeedback.impactOccurred("light");
  updateIdle();
  render();
  savePlayer();
}

function upgrade() {
  const cost = 20 * data.rate * data.rate;
  if (data.voids < cost) {
    Telegram.WebApp.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ VOID");
    return;
  }
  data.voids -= cost;
  data.rate++;
  render();
  savePlayer();
}

/* ===== SERVER ===== */
async function loadPlayer() {
  const { data: p } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", user.id)
    .single();

  // –µ—Å–ª–∏ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º
  if (!p) {
    const newPlayer = {
      telegram_id: user.id,
      username: user.username || user.first_name || "Unknown",
      voids: 0,
      rate: 1,
      is_vip: false
    };

    await supabase.from("players").insert(newPlayer);
    return newPlayer;
  }

  // üî• –ï–°–õ–ò –ò–ì–†–û–ö –ï–°–¢–¨, –ù–û –ù–ò–ö–ê –ù–ï–¢ ‚Äî –û–ë–ù–û–í–õ–Ø–ï–ú
  if (!p.username) {
    await supabase
      .from("players")
      .update({
        username: user.username || user.first_name || "Unknown"
      })
      .eq("telegram_id", user.id);

    p.username = user.username || user.first_name || "Unknown";
  }

  return p;
}

async function loadLeaderboard() {
  const { data: list, error } = await supabase
    .from("players")
    .select("telegram_id, voids, is_vip, username")
    .order("voids", { ascending: false })
    .limit(100);

  if (error) {
    console.error(error);
    return;
  }

  const top3 = document.getElementById("top3");
  const board = document.getElementById("leaderboard");
  const myRankBox = document.getElementById("my-rank");

  top3.innerHTML = "";
  board.innerHTML = "";
  myRankBox.innerHTML = "";

  let myIndex = -1;

  list.forEach((p, i) => {
    if (p.telegram_id === user.id) myIndex = i;
  });

  // TOP 3
  const medals = ["gold", "silver", "bronze"];

  list.slice(0, 3).forEach((p, i) => {
    const div = document.createElement("div");
    div.className = `top3-item ${medals[i]}`;
    div.innerHTML = `
      <div>${i + 1} –º–µ—Å—Ç–æ</div>
      <strong>${p.username || "–ò–≥—Ä–æ–∫"}</strong>
      <div>${p.voids} VOID ${p.is_vip ? "üëë" : ""}</div>
    `;
    top3.appendChild(div);
  });

  // LIST (4‚Äì100)
  list.slice(3).forEach((p, i) => {
    const row = document.createElement("div");
    row.className = "lb-row";

    if (p.telegram_id === user.id) row.classList.add("me");

    row.innerHTML = `
      <span>${i + 4}. ${p.username || "–ò–≥—Ä–æ–∫"} ${p.is_vip ? "üëë" : ""}</span>
      <span>${p.voids} VOID</span>
    `;
    board.appendChild(row);
  });

  // MY POSITION
  if (myIndex !== -1) {
    myRankBox.innerHTML = `
      üî• –¢–≤–æ—è –ø–æ–∑–∏—Ü–∏—è: <strong>${myIndex + 1}</strong><br>
      VOID: <strong>${list[myIndex].voids}</strong>
    `;
  }
}


/* ===== TABS ===== */
function showTab(tab, el) {
  game.style.display = tab === "game" ? "block" : "none";
  rating.style.display = tab === "rating" ? "block" : "none";
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  el.classList.add("active");
  if (tab === "rating") loadLeaderboard();
}

/* ===== INIT ===== */
(async () => {
  const p = await loadPlayer();
  data.voids = p.voids;
  data.rate = p.rate;
  data.is_vip = p.is_vip;
  data.lastTime = Date.now();
  render();
  loadLeaderboard();
  setInterval(savePlayer, 15000);
  setInterval(loadLeaderboard, 20000);
})();
</script>

</body>
</html>
