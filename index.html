<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <meta charset="UTF-8" />
  <title>Dark Idle</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
  body {
    background: #0e0e11;
    color: #ffffff;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  h1 {
    font-size: 32px;
  }
  p {
    font-size: 20px;
  }
  button {
    background: #6f42c1;
    border: none;
    padding: 18px 24px;
    color: white;
    font-size: 18px;
    border-radius: 14px;
    cursor: pointer;
    width: 100%;
    max-width: 320px;
    margin: 10px auto;
    display: block;
  }
  </style>
</head>
<body>

<h1>Dark Idle</h1>
<p id="counter">VOID: 0</p>
<p id="info"></p>

<button onclick="collect()">–ó–∞–±—Ä–∞—Ç—å VOID</button>
<button onclick="upgrade()">–£–ª—É—á—à–∏—Ç—å –¥–æ–±—ã—á—É</button>
  <hr style="margin: 30px 0; opacity: 0.3">

<h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
<div id="leaderboard"></div>

<script>
  const SUPABASE_URL = "https://edosyzmykmoajecmaamu.supabase.co";
  const SUPABASE_KEY = "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );
</script>

<script>
  const tg = Telegram.WebApp;
const user = tg.initDataUnsafe?.user;

if (!user) {
  alert("–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram");
}

  Telegram.WebApp.ready();

  let data = JSON.parse(localStorage.getItem("darkIdle")) || {
    voids: 0,
    rate: 1,
    lastTime: Date.now()
  };

  function updateIdle() {
    const now = Date.now();
    const seconds = Math.floor((now - data.lastTime) / 1000);
    if (seconds > 0) {
      data.voids += seconds * data.rate;
      data.lastTime = now;
    }
    save();
  }

  function collect() {
    updateIdle();
    render();
    savePlayerToServer();

  }

  function upgrade() {
    if (data.voids >= 10) {
      data.voids -= 10;
      data.rate++;
      save();
      render();
    } else {
      alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ VOID");
      savePlayerToServer();

    }
  }

  function save() {
    localStorage.setItem("darkIdle", JSON.stringify(data));
  }

  function render() {
    document.getElementById("counter").innerText =
      `VOID: ${Math.floor(data.voids)}`;
    document.getElementById("info").innerText =
      `–°–∫–æ—Ä–æ—Å—Ç—å: ${data.rate} VOID/—Å–µ–∫`;
  }
  async function savePlayerToServer() {
  await supabase
    .from("players")
    .update({
      voids: Math.floor(data.voids),
      rate: data.rate,
      updated_at: new Date()
    })
    .eq("telegram_id", user.id);
}

async function loadPlayerFromServer() {
  const telegramId = user.id;

  let { data: player, error } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", telegramId)
    .single();

  if (!player) {
    await supabase.from("players").insert({
      telegram_id: telegramId,
      voids: 0,
      rate: 1
    });
    async function loadLeaderboard() {
  const { data, error } = await supabase
    .from("players")
    .select("telegram_id, voids")
    .order("voids", { ascending: false })
    .limit(100);

  if (error) {
    console.error(error);
    return;
  }

  const list = document.getElementById("leaderboard");
  list.innerHTML = "";

  data.forEach((player, index) => {
    const row = document.createElement("div");

    const isMe = player.telegram_id === user.id;

    row.innerText = `${index + 1}. ${isMe ? "üî• –¢—ã" : "–ò–≥—Ä–æ–∫"} ‚Äî ${player.voids} VOID`;

    row.style.padding = "6px";
    row.style.fontWeight = isMe ? "bold" : "normal";
    row.style.color = isMe ? "#ffd700" : "#ffffff";

    list.appendChild(row);
  });
}


    return { voids: 0, rate: 1 };
  }

  return player;
}

 (async () => {
  tg.ready();

  const serverData = await loadPlayerFromServer();

  data.voids = serverData.voids;
  data.rate = serverData.rate;
  data.lastTime = Date.now();

  render();
   loadLeaderboard();
   setInterval(() => {
  savePlayerToServer();
}, 15000); // –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
   setInterval(() => {
  loadLeaderboard();
}, 20000); // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫


})();

</script>

</body>
</html>
