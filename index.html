<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>ASH ‚Äî Core</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --core-speed: 10s;
  --accent-color: #8a63ff;
}

body {
  background: #0a0a0c;
  color: #fff;
  font-family: 'Segoe UI', Roboto, sans-serif;
  text-align: center;
  margin: 0;
  padding: 20px;
  padding-bottom: 110px;
  overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ª–∏—à–Ω–∏–π —Å–∫—Ä–æ–ª–ª */
}

h1 { font-weight: 300; letter-spacing: 4px; color: rgba(255,255,255,0.9); }

.void-card {
  background: radial-gradient(circle at center, #16161d 0%, #000 100%);
  border-radius: 30px;
  padding: 40px 20px;
  border: 1px solid rgba(255,255,255,0.05);
}

.void-orb {
  width: 240px; height: 240px;
  margin: 0 auto 30px;
  position: relative;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
}

/* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –≤–æ–∫—Ä—É–≥ —è–¥—Ä–∞ */
.void-orb::after {
  content: ''; position: absolute;
  width: 100%; height: 100%;
  border-radius: 50%;
  box-shadow: 0 0 50px rgba(138, 99, 255, 0.3);
  animation: pulse 4s ease-in-out infinite;
}

#voidImage {
  width: 80%; height: 80%;
  object-fit: contain;
  filter: drop-shadow(0 0 20px var(--accent-color));
  animation: spin var(--core-speed) linear infinite;
}

@keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

.void-amount { font-size: 38px; font-weight: 700; margin-bottom: 5px; font-variant-numeric: tabular-nums; }
.void-sub { font-size: 13px; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; }

.void-btn {
  background: #fff; color: #000;
  border: none; padding: 18px;
  font-size: 16px; font-weight: bold;
  border-radius: 16px; cursor: pointer;
  width: 100%; max-width: 280px;
  margin: 15px auto;
  transition: transform 0.1s;
}
.void-btn:active { transform: scale(0.96); }

.void-btn.secondary {
  background: rgba(255,255,255,0.1); color: #fff;
  backdrop-filter: blur(10px);
}

.void-info { margin-top: 10px; font-size: 14px; color: var(--accent-color); }

/* –¢–∞–±–±–∞—Ä –∏ –ø—Ä–æ—á–µ–µ */
#tabbar {
  position: fixed; bottom: 20px; left: 20px; right: 20px;
  height: 70px; background: rgba(255,255,255,0.05);
  backdrop-filter: blur(20px); border-radius: 25px;
  display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1);
}
.tab { flex: 1; opacity: 0.4; font-size: 11px; cursor: pointer; transition: 0.3s; }
.tab.active { opacity: 1; color: var(--accent-color); }

.leaderboard { max-height: 60vh; overflow-y: auto; padding-right: 5px; }
.lb-row {
  display: flex; justify-content: space-between; padding: 15px;
  background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 12px;
}
.lb-row.me { border: 1px solid var(--accent-color); background: rgba(138, 99, 255, 0.1); }
</style>
</head>

<body>

<div id="game-page">
  <h1>ASH</h1>
  <div class="void-card">
    <div class="void-orb">
      <img src="https://cdn-icons-png.flaticon.com/512/1805/1805721.png" id="voidImage">
    </div>
    <div class="void-amount" id="counter">0</div>
    <div class="void-sub">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è</div>
    
    <button class="void-btn" onclick="collect()">–ò–ó–í–õ–ï–ß–¨ ASH</button>
    <button class="void-btn secondary" onclick="upgrade()">–£–õ–£–ß–®–ò–¢–¨ (–¶–µ–Ω–∞: <span id="upgradeCost">0</span>)</button>
    
    <div class="void-info" id="rateInfo">–°–∫–æ—Ä–æ—Å—Ç—å: 1 ASH/—Å–µ–∫</div>
  </div>
</div>

<div id="rating-page" style="display:none">
  <h2>üèÜ TOP EXTRACTORS</h2>
  <div id="leaderboard" class="leaderboard"></div>
</div>

<div id="tabbar">
  <div class="tab active" id="tab-game" onclick="showTab('game')">üåÄ<br>Core</div>
  <div class="tab" id="tab-rating" onclick="showTab('rating')">üèÜ<br>Rank</div>
</div>

<script>
/* ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===== */
const supabase = window.supabase.createClient(
  "https://edosyzmykmoajecmaamu.supabase.co",
  "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O"
);

const tg = Telegram.WebApp;
tg.expand();

const state = {
  ash: 0,
  rate: 1,
  last_seen: Date.now(),
  is_vip: false
};

/* ===== –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê (–ë–ï–ó –ü–û–¢–ï–†–¨) ===== */
function syncProgress() {
  const now = Date.now();
  const diffMs = now - state.last_seen;
  
  if (diffMs >= 1000) {
    const seconds = Math.floor(diffMs / 1000);
    state.ash += seconds * state.rate * (state.is_vip ? 2 : 1);
    state.last_seen += seconds * 1000; // –û—Å—Ç–∞–≤–ª—è–µ–º –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–∏–∫–∞
  }
}

/* ===== –í–ò–ó–£–ê–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï (60 FPS) ===== */
function render() {
  const now = Date.now();
  const diffMs = now - state.last_seen;
  // –í–∏–∑—É–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º "—Ö–≤–æ—Å—Ç" –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
  const visualAsh = state.ash + (diffMs / 1000 * state.rate * (state.is_vip ? 2 : 1));
  
  document.getElementById('counter').innerText = Math.floor(visualAsh).toLocaleString();
  
  const cost = 20 * state.rate * state.rate;
  document.getElementById('upgradeCost').innerText = cost;
  document.getElementById('rateInfo').innerText = `–°–∫–æ—Ä–æ—Å—Ç—å: ${state.rate} ASH/—Å–µ–∫`;
  
  // –ú–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è Core –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç rate
  const speed = Math.max(2, 20 - state.rate); 
  document.documentElement.style.setProperty('--core-speed', `${speed}s`);
  
  requestAnimationFrame(render);
}

/* ===== –î–ï–ô–°–¢–í–ò–Ø ===== */
async function collect() {
  tg.HapticFeedback.impactOccurred("medium");
  syncProgress();
  await save();
}

async function upgrade() {
  const cost = 20 * state.rate * state.rate;
  syncProgress();
  
  if (state.ash >= cost) {
    state.ash -= cost;
    state.rate += 1;
    tg.HapticFeedback.notificationOccurred("success");
    await save();
  } else {
    tg.HapticFeedback.notificationOccurred("error");
    tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ ASH");
  }
}

/* ===== –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô ===== */
async function loadPlayer() {
  const user = tg.initDataUnsafe.user || { id: 12345, username: "Guest" };
  
  let { data: p } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", user.id)
    .single();

  if (!p) {
    p = {
      telegram_id: user.id,
      username: user.username || "Unknown",
      voids: 0,
      rate: 1,
      last_seen: new Date().toISOString()
    };
    await supabase.from("players").insert(p);
  }

  state.ash = p.voids; // –í –ë–î –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è voids
  state.rate = p.rate;
  state.last_seen = new Date(p.last_seen).getTime();
}

async function save() {
  const user = tg.initDataUnsafe.user || { id: 12345 };
  await supabase.from("players").update({
    voids: Math.floor(state.ash),
    rate: state.rate,
    last_seen: new Date(state.last_seen).toISOString()
  }).eq("telegram_id", user.id);
}

/* ===== UI ===== */
function showTab(tab) {
  document.getElementById('game-page').style.display = tab === 'game' ? 'block' : 'none';
  document.getElementById('rating-page').style.display = tab === 'rating' ? 'block' : 'none';
  
  document.getElementById('tab-game').classList.toggle('active', tab === 'game');
  document.getElementById('tab-rating').classList.toggle('active', tab === 'rating');
  
  if (tab === 'rating') loadLeaderboard();
}

async function loadLeaderboard() {
  const { data: list } = await supabase
    .from("players")
    .select("*")
    .order("voids", { ascending: false })
    .limit(50);

  const container = document.getElementById('leaderboard');
  container.innerHTML = list.map((p, i) => `
    <div class="lb-row ${p.telegram_id == tg.initDataUnsafe.user?.id ? 'me' : ''}">
      <span>${i + 1}. ${p.username}</span>
      <span><b>${p.voids}</b></span>
    </div>
  `).join('');
}

/* ===== –ó–ê–ü–£–°–ö ===== */
(async () => {
  await loadPlayer();
  syncProgress(); // –°—á–∏—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥ —Å—Ä–∞–∑—É
  render();       // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
  
  // –§–æ–Ω–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑ –≤ 15 —Å–µ–∫
  setInterval(() => {
    syncProgress();
    save();
  }, 15000);
})();
</script>

</body>
</html>
