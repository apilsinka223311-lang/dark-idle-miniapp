<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ASH: Dark Cosmos</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&family=Orbitron:wght@500;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#050508;
  --primary:#8a63ff;
  --glow:rgba(138,99,255,.6);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(circle at 50% 30%,#1a1033,#050508 80%);
  color:#fff;
  font-family:'Exo 2',sans-serif;
  height:100vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.screen{
  flex:1;
  display:none;
  align-items:center;
  flex-direction:column;
  padding:20px 20px 100px;
  overflow-y:auto;
}
.screen.active{display:flex}
h1{
  font-family:'Orbitron',sans-serif;
  margin-top:15px;
  text-shadow:0 0 15px var(--glow);
}
.core-wrapper{
  position:relative;
  width:260px;
  height:260px;
  margin:25px 0;
}
.core-sphere{
  width:160px;
  height:160px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#d4bfff,#8a63ff,#240046);
  box-shadow:0 0 50px var(--glow),inset -10px -10px 30px rgba(0,0,0,.8);
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
}
.orbit{
  position:absolute;
  border-radius:50%;
  border:1px solid rgba(138,99,255,.3);
  top:50%;left:50%;
  transform:translate(-50%,-50%);
}
.orbit1{width:220px;height:220px;animation:spin 12s linear infinite}
.orbit2{width:260px;height:260px;animation:spinR 18s linear infinite}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
@keyframes spinR{to{transform:translate(-50%,-50%) rotate(-360deg)}}

.balance{
  font-family:'Orbitron',sans-serif;
  font-size:48px;
}
.label{opacity:.6;font-size:12px;letter-spacing:2px}

.btn{
  width:100%;
  max-width:320px;
  padding:16px;
  border-radius:16px;
  margin-bottom:12px;
  border:none;
  cursor:pointer;
  color:#fff;
  font-weight:bold;
  background:rgba(255,255,255,.08);
}
.btn-main{
  background:linear-gradient(135deg,var(--primary),#6333ff);
  box-shadow:0 8px 30px var(--glow);
}

.tabbar{
  position:fixed;
  bottom:20px;left:20px;right:20px;
  height:70px;
  background:rgba(20,20,30,.9);
  border-radius:24px;
  display:flex;
  justify-content:space-around;
  align-items:center;
}
.tab{opacity:.4;text-align:center;cursor:pointer}
.tab.active{opacity:1;color:var(--primary)}
</style>
</head>

<body>

<div id="screen-game" class="screen active">
  <h1>ASH CORE</h1>

  <div class="core-wrapper">
    <div class="orbit orbit1"></div>
    <div class="orbit orbit2"></div>
    <div class="core-sphere"></div>
  </div>

  <div class="balance" id="ui-ash">0</div>
  <div class="label">–≠–ù–ï–†–ì–ò–Ø ASH</div>

  <button class="btn btn-main" id="btn-collect">–ò–ó–í–õ–ï–ß–¨</button>
  <button class="btn" id="btn-upgrade">
    –£–õ–£–ß–®–ò–¢–¨<br>
    <small>–¶–µ–Ω–∞: <span id="ui-cost">20</span> | <span id="ui-rate">1</span>/—Å–µ–∫</small>
  </button>
</div>

<div id="screen-rating" class="screen">
  <h1>–†–ï–ô–¢–ò–ù–ì</h1>
  <div id="leaderboard" style="width:100%"></div>
</div>

<div class="tabbar">
  <div class="tab active" onclick="setTab('game',this)">üåÄ<br>Core</div>
  <div class="tab" onclick="setTab('rating',this)">üèÜ<br>Rank</div>
</div>

<script>
/* ===== CONFIG ===== */
const supabase = window.supabase.createClient(
  "https://edosyzmykmoajecmaamu.supabase.co",
  "sb_publishable_bHorYMm55LbnpSXg96WwVw_C4weLD_O"
);

const tg = Telegram.WebApp;
tg.ready();

/* ===== STATE ===== */
let state = {
  ash: 0,
  rate: 1,
  telegram_id: null,
  username: "Player",
  last_seen: Date.now()
};

/* ===== INIT ===== */
(async function init(){
  const user = tg.initDataUnsafe?.user;
  if(!user) return;

  state.telegram_id = user.id;
  state.username = user.username || user.first_name || "Player";

  let { data: p } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", state.telegram_id)
    .single();

  if(!p){
    p = {
      telegram_id: state.telegram_id,
      username: state.username,
      ash: 0,
      rate: 1,
      last_seen: new Date().toISOString()
    };
    await supabase.from("players").insert(p);
  }

  state.ash = p.ash;
  state.rate = p.rate;

  if(p.last_seen){
    const diff = (Date.now() - new Date(p.last_seen).getTime()) / 1000;
    if(diff > 0) state.ash += diff * state.rate;
  }

  state.last_seen = Date.now();
  render();
  save();
})();

/* ===== GAME LOOP ===== */
setInterval(()=>{
  const now = Date.now();
  const diff = (now - state.last_seen)/1000;
  if(diff>0){
    state.ash += diff * state.rate;
    state.last_seen = now;
    render();
  }
},1000);

/* ===== UI ===== */
function render(){
  document.getElementById("ui-ash").innerText = Math.floor(state.ash);
  document.getElementById("ui-rate").innerText = state.rate;
  document.getElementById("ui-cost").innerText = 20 * state.rate * state.rate;
}

/* ===== ACTIONS ===== */
document.getElementById("btn-collect").onclick = ()=>{
  state.ash += state.rate;
  tg.HapticFeedback.impactOccurred("light");
  render();
  save();
};

document.getElementById("btn-upgrade").onclick = ()=>{
  const cost = 20 * state.rate * state.rate;
  if(state.ash < cost) return;
  state.ash -= cost;
  state.rate++;
  render();
  save();
};

/* ===== SAVE ===== */
function save(){
  supabase.from("players").update({
    ash: Math.floor(state.ash),
    rate: state.rate,
    last_seen: new Date().toISOString(),
    username: state.username
  }).eq("telegram_id", state.telegram_id);
}

/* ===== RATING ===== */
async function loadLeaderboard(){
  const { data } = await supabase
    .from("players")
    .select("username, ash")
    .order("ash",{ascending:false})
    .limit(20);

  leaderboard.innerHTML = data.map((p,i)=>`
    <div style="padding:10px;border-bottom:1px solid #333">
      #${i+1} ${p.username} ‚Äî <b>${p.ash}</b>
    </div>
  `).join("");
}

/* ===== TABS ===== */
function setTab(name,el){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById("screen-"+name).classList.add("active");
  el.classList.add("active");
  if(name==="rating") loadLeaderboard();
}
</script>

</body>
</html>
